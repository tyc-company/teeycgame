<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ¨ç®±å­ ğŸ§±ğŸ“¦ğŸ¤—âŒ</title>
<style>
body{font-family:Arial;text-align:center}
table{margin:auto;border-collapse:collapse}
td{width:40px;height:40px;font-size:30px;text-align:center}
button{margin:4px;padding:6px 10px;font-size:16px}
</style>
</head>
<body>

<h2>æ¨ç®±å­</h2>

<div>
  <button onclick="move(0,-1)">â¬†</button><br>
  <button onclick="move(-1,0)">â¬…</button>
  <button onclick="move(1,0)">â¡</button><br>
  <button onclick="move(0,1)">â¬‡</button>
</div>

<div>
  <button onclick="undo()">â†© æ’¤é”€</button>
  <button onclick="resetLevel()">ğŸ”„ é‡ç½®</button>
</div>

<div id="info"></div>
<div id="game"></div>

<script>
const WALL='ğŸ§±', ROCK='ğŸª¨', BOX='ğŸ“¦', TARGET='âŒ', BOX_OK='âœ…';

let width=8, height=8;
let ground=[], boxes=[], player={x:0,y:0};
let history=[];

// åˆå§‹åŒ–å…³å¡
function generateLevel(){
  ground=Array.from({length:height},()=>Array(width).fill(' '));
  boxes=[]; history=[];

  // å¢™
  for(let y=0;y<height;y++)
    for(let x=0;x<width;x++)
      if(x===0||y===0||x===width-1||y===height-1)
        ground[y][x]=WALL;

  // éšœç¢
  for(let i=0;i<6;i++){
    let x,y;
    do{
      x=rand(1,width-2); y=rand(1,height-2);
    }while(ground[y][x]!==' ');
    ground[y][x]=ROCK;
  }

  // ç©å®¶
  do{
    player.x=rand(1,width-2);
    player.y=rand(1,height-2);
  }while(ground[player.y][player.x]!==' ');

  // ç®±å­ + ç›®æ ‡
  for(let i=0;i<3;i++){
    let bx,by,tx,ty;
    do{
      bx=rand(1,width-2); by=rand(1,height-2);
    }while(ground[by][bx]!==' '||isCorner(bx,by));
    boxes.push({x:bx,y:by,on:false});

    do{
      tx=rand(1,width-2); ty=rand(1,height-2);
    }while(ground[ty][tx]!==' ');
    ground[ty][tx]=TARGET;
  }

  save();
  draw();
}

// åˆ¤æ–­è§’è½
function isCorner(x,y){
  let w=0;
  if(ground[y-1][x]===WALL)w++;
  if(ground[y+1][x]===WALL)w++;
  if(ground[y][x-1]===WALL)w++;
  if(ground[y][x+1]===WALL)w++;
  return w>=2;
}

// ç§»åŠ¨
function move(dx,dy){
  let nx=player.x+dx, ny=player.y+dy;
  if(isBlock(nx,ny)) return;

  let box=boxAt(nx,ny);
  if(box){
    let nnx=nx+dx, nny=ny+dy;
    if(isBlock(nnx,nny)||boxAt(nnx,nny)) return;
    box.x=nnx; box.y=nny;
  }

  player.x=nx; player.y=ny;
  updateBoxes();
  save();
  draw();
  checkWin();
}

// é˜»æŒ¡
function isBlock(x,y){
  return ground[y][x]===WALL||ground[y][x]===ROCK;
}

// ç®±å­
function boxAt(x,y){
  return boxes.find(b=>b.x===x&&b.y===y&&!b.on);
}

// æ›´æ–°ç®±å­æ˜¯å¦åˆ°ç›®æ ‡
function updateBoxes(){
  boxes.forEach(b=>{
    b.on=ground[b.y][b.x]===TARGET;
  });
}

// ç»˜åˆ¶
function draw(){
  let html='<table>';
  for(let y=0;y<height;y++){
    html+='<tr>';
    for(let x=0;x<width;x++){
      let ch=ground[y][x];
      let b=boxes.find(b=>b.x===x&&b.y===y);
      if(b) ch=b.on?BOX_OK:BOX;
      if(player.x===x&&player.y===y) ch='ğŸ¤—';
      html+=`<td>${ch}</td>`;
    }
    html+='</tr>';
  }
  html+='</table>';
  document.getElementById('game').innerHTML=html;
}

// èƒœåˆ©
function checkWin(){
  if(boxes.every(b=>b.on)){
    alert('å®Œæˆ ğŸ‰');
    generateLevel();
  }
}

// æ’¤é”€
function save(){
  history.push({
    p:{...player},
    b:boxes.map(o=>({...o}))
  });
  if(history.length>50)history.shift();
}

function undo(){
  if(history.length<2) return;
  history.pop();
  let s=history[history.length-1];
  player={...s.p};
  boxes=s.b.map(o=>({...o}));
  draw();
}

// é‡ç½®
function resetLevel(){
  generateLevel();
}

// é”®ç›˜ï¼ˆç®­å¤´ + WASDï¼‰
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowUp'||e.key==='w')move(0,-1);
  if(e.key==='ArrowDown'||e.key==='s')move(0,1);
  if(e.key==='ArrowLeft'||e.key==='a')move(-1,0);
  if(e.key==='ArrowRight'||e.key==='d')move(1,0);
});

function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a;}

generateLevel();
</script>

</body>
</html>

