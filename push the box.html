<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ¨ç®±å­ ğŸ§±ğŸ“¦ğŸ¤—âŒ</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; }
  table { margin: 20px auto; border-collapse: collapse; }
  td { width: 40px; height: 40px; text-align: center; vertical-align: middle; font-size: 32px; border: 1px solid #ccc; }
  button { margin: 5px; padding: 5px 10px; font-size: 16px; }
  #controls { margin:10px; }
</style>
</head>
<body>

<h2>æ¨ç®±å­ ğŸª¨ğŸ“¦ğŸ¤—âŒ</h2>

<div id="controls">
  <button onclick="move(-1,0)">å·¦</button>
  <button onclick="move(1,0)">å³</button>
  <button onclick="move(0,-1)">ä¸Š</button>
  <button onclick="move(0,1)">ä¸‹</button>
  <button onclick="undo()">æ’¤é”€</button>
  <button onclick="resetLevel()">é‡ç½®å…³å¡</button>
</div>

<div id="levelInfo"></div>
<div id="gameBoard"></div>

<script>
const WALL = 'ğŸ§±';
const OBSTACLE = 'ğŸª¨';
const PLAYER = 'ğŸ¤—';
const BOX = 'ğŸ“¦';
const TARGET = 'âŒ';
const BOX_ON_TARGET = 'âœ…';

let currentLevel = 1;
let map = [];
let player = {x:0,y:0};
let width = 8;
let height = 8;

// ä¿å­˜å†å²çŠ¶æ€ï¼Œç”¨äºæ’¤é”€
let history = [];

// æ·±æ‹·è´åœ°å›¾
function copyMap(m){
    return m.map(row=>row.slice());
}

// éšæœºç”Ÿæˆä¸€å…³
function generateLevel() {
    map = Array.from({length:height},()=>Array.from({length:width},()=> ' '));
    // å¢™è¾¹
    for(let y=0;y<height;y++){
        for(let x=0;x<width;x++){
            if(x===0||y===0||x===width-1||y===height-1) map[y][x]=WALL;
        }
    }
    // éšœç¢ç‰©
    for(let i=0;i<8;i++){
        while(true){
            let ox = Math.floor(Math.random()*(width-2))+1;
            let oy = Math.floor(Math.random()*(height-2))+1;
            if(map[oy][ox]===' '){
                map[oy][ox]=OBSTACLE;
                break;
            }
        }
    }
    // ç©å®¶
    while(true){
        let px=Math.floor(Math.random()*(width-2))+1;
        let py=Math.floor(Math.random()*(height-2))+1;
        if(map[py][px]===' '){
            map[py][px]=PLAYER;
            player={x:px,y:py};
            break;
        }
    }
    // ç®±å­å’Œç›®æ ‡
    let boxCount=3;
    let boxes=[],targets=[];
    function isCorner(x,y){
        let wallCount=0;
        if(map[y-1][x]===WALL) wallCount++;
        if(map[y+1][x]===WALL) wallCount++;
        if(map[y][x-1]===WALL) wallCount++;
        if(map[y][x+1]===WALL) wallCount++;
        return wallCount>=2;
    }
    for(let i=0;i<boxCount;i++){
        while(true){
            let bx=Math.floor(Math.random()*(width-2))+1;
            let by=Math.floor(Math.random()*(height-2))+1;
            if(map[by][bx]===' ' && !isCorner(bx,by)){
                map[by][bx]=BOX;
                boxes.push({x:bx,y:by});
                break;
            }
        }
        while(true){
            let tx=Math.floor(Math.random()*(width-2))+1;
            let ty=Math.floor(Math.random()*(height-2))+1;
            if(map[ty][tx]===' '){
                map[ty][tx]=TARGET;
                targets.push({x:tx,y:ty});
                break;
            }
        }
    }
    history=[];
    saveHistory();
}

// ä¿å­˜å½“å‰çŠ¶æ€
function saveHistory(){
    history.push({
        map:copyMap(map),
        player:{x:player.x,y:player.y}
    });
    if(history.length>50) history.shift(); // é™åˆ¶æœ€å¤§å†å²
}

// æ’¤é”€
function undo(){
    if(history.length<=1) return;
    history.pop();
    let state = history[history.length-1];
    map = copyMap(state.map);
    player = {x:state.player.x,y:state.player.y};
    drawMap();
}

// ç»˜åˆ¶åœ°å›¾
function drawMap(){
    const board = document.getElementById('gameBoard');
    let html='<table>';
    for(let y=0;y<map.length;y++){
        html+='<tr>';
        for(let x=0;x<map[y].length;x++){
            html+=`<td>${map[y][x]}</td>`;
        }
        html+='</tr>';
    }
    html+='</table>';
    board.innerHTML=html;
    document.getElementById('levelInfo').innerText = `ç¬¬ ${currentLevel} å…³`;
}

// ç§»åŠ¨
function move(dx,dy){
    const nx = player.x+dx;
    const ny = player.y+dy;
    const nnx = nx+dx;
    const nny = ny+dy;

    if(map[ny][nx]===WALL || map[ny][nx]===OBSTACLE) return;

    if(map[ny][nx]===BOX || map[ny][nx]===BOX_ON_TARGET){
        if(map[nny][nnx]===' '){
            map[nny][nnx]=BOX;
        } else if(map[nny][nnx]===TARGET){
            map[nny][nnx]=BOX_ON_TARGET;
        } else return;
        map[ny][nx]=(map[ny][nx]===BOX_ON_TARGET)?TARGET:' ';
    }

    // ç©å®¶ç«™åœ¨ç›®æ ‡ä¸Šï¼Œç›®æ ‡ä¿ç•™
    if(map[player.y][player.x]===PLAYER){
        map[player.y][player.x]=' ';
    }

    // å¦‚æœç©å®¶ç§»åŠ¨åˆ°ç›®æ ‡ï¼Œä¸è¦†ç›–ç›®æ ‡
    if(map[ny][nx]===TARGET) map[ny][nx]=PLAYER;
    else map[ny][nx]=PLAYER;

    player={x:nx,y:ny};
    saveHistory();
    drawMap();
    checkWin();
}

// æ£€æŸ¥èƒœåˆ©
function checkWin(){
    for(let y=0;y<height;y++){
        for(let x=0;x<width;x++){
            if(map[y][x]===BOX) return;
        }
    }
    alert('å…³å¡å®Œæˆ ğŸ‰');
    currentLevel++;
    generateLevel();
    drawMap();
}

// WASD æ§åˆ¶
document.addEventListener('keydown', e=>{
    if(e.key==='w') move(0,-1);
    else if(e.key==='s') move(0,1);
    else if(e.key==='a') move(-1,0);
    else if(e.key==='d') move(1,0);
});

// é‡ç½®å…³å¡
function resetLevel(){
    generateLevel();
    drawMap();
}

// åˆå§‹åŒ–
generateLevel();
drawMap();
</script>

</body>
</html>

