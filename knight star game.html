<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>骑士走星棋</title>

  <link rel="stylesheet" type="text/css" href="./_ejs_library/css/ejss.css" />
  <script src="./_ejs_library/scripts/textresizedetector.js"></script>
  <script src="./_ejs_library/ejsS.v1.min.js"></script>

<script>
function _simulation (_topFrame,_libraryPath,_codebasePath) {

  var _model = EJSS_CORE.createAnimationLMS();
  var _view;

  var numOfRows = 6, numOfCols = 6;
  var squareX=[], squareY=[], squareColor=[], squareFilled=[], squareHighlighted=[];
  var idxToPos=[], posToIdx=[];
  var symbolStr=[], symbolX=[], symbolY=[];
  var textStr=[], textX=[], textY=[];
  var squareLength = 1;
  var numOfSquares = 0, numOfStars = 0;
  var moveCounter = 1, topScore = 0;
  var gameOver = false, interact;

  var filledColor = "rgba(0,255,0,0.5)";
  var unfilledColor = "rgba(0,0,255,0.5)";
  var highlightColor = "#aed581";

  var font = "normal normal 2vw";
  var fontSymbol = "normal normal 5vw";

  var textXunicode = -1, textYunicode = 0;

  function findPossibleMoves(x,y){
    const dx=[-1,1,2,2,-1,1,-2,-2];
    const dy=[2,2,1,-1,-2,-2,1,-1];
    var possible=false;

    for(let i=0;i<8;i++){
      let nx=x+dx[i], ny=y+dy[i];
      if(nx<0||nx>=numOfCols||ny<0||ny>=numOfRows) continue;
      let idx=posToIdx[ny][nx];
      if(!squareFilled[idx]){
        squareHighlighted[idx]=1;
        possible=true;
      }
    }
    return possible;
  }

  function onClickSquare(idx){
    if(gameOver) return;
    if(!squareHighlighted[idx]) return;

    let x=idxToPos[idx][0], y=idxToPos[idx][1];
    squareFilled[idx]=1;
    squareColor[idx]=filledColor;

    textStr.push(moveCounter++);
    textX.push(x*squareLength);
    textY.push(y*squareLength);
    textXunicode=x*squareLength;
    textYunicode=y*squareLength;

    for(let i=0;i<numOfSquares;i++){
      squareHighlighted[i]=0;
      if(squareColor[i]===highlightColor)
        squareColor[i]=unfilledColor;
    }

    topScore=Math.max(topScore,moveCounter-1);

    if(moveCounter===numOfStars+1 || !findPossibleMoves(x,y)){
      gameOver=true;
    }
  }

  _model.addToInitialization(function(){
    var board=[
      "*OO**O",
      "O***OO",
      "******",
      "****O*",
      "*O***O",
      "O****O"
    ];

    squareX=[]; squareY=[]; squareColor=[];
    squareFilled=[]; squareHighlighted=[];
    symbolStr=[]; symbolX=[]; symbolY=[];
    idxToPos=[]; posToIdx=[];
    textStr=[]; textX=[]; textY=[];
    numOfSquares=0; numOfStars=0;
    moveCounter=1; gameOver=false;

    for(let i=0;i<numOfRows;i++){
      posToIdx.push([]);
      for(let j=0;j<numOfCols;j++){
        if(board[i][j]==="*"){
          squareFilled.push(0);
          squareHighlighted.push(1);
          symbolStr.push("⭐");
          symbolX.push(j);
          symbolY.push(i);
          numOfStars++;
        } else {
          squareFilled.push(1);
          squareHighlighted.push(0);
        }
        squareX.push(j);
        squareY.push(i);
        squareColor.push(unfilledColor);
        idxToPos.push([j,i]);
        posToIdx[i].push(numOfSquares++);
      }
    }
  });

  function _createView(){
    _view=EJSS_CORE.createView(_topFrame);
    _view._setLibraryPath(_libraryPath);

    _view._addElement(EJSS_DRAWING2D.plottingPanel,'panel',_view._topFrame)
      .setProperty("SquareAspect",true)
      .setProperty("Height","95vh");

    _view._addElement(EJSS_DRAWING2D.shapeSet,'board',_view.panel)
      .setProperty("ShapeType","RECTANGLE")
      .setProperty("X",()=>squareX)
      .setProperty("Y",()=>squareY)
      .setProperty("SizeX",squareLength)
      .setProperty("SizeY",squareLength)
      .setProperty("FillColor",()=>squareColor)
      .setProperty("ElementInteracted",()=>interact)
      .setAction("OnPress",()=>onClickSquare(interact));

    _view._addElement(EJSS_DRAWING2D.textSet,'stars',_view.panel)
      .setProperty("Text",()=>symbolStr)
      .setProperty("X",()=>symbolX)
      .setProperty("Y",()=>symbolY)
      .setProperty("Font",fontSymbol);

    _view._addElement(EJSS_DRAWING2D.text,'knight',_view.panel)
      .setProperty("Text","♞")
      .setProperty("X",()=>textXunicode)
      .setProperty("Y",()=>textYunicode)
      .setProperty("Font","normal normal 7vw")
      .setProperty("FillColor","magenta");

    _view._addElement(EJSS_DRAWING2D.textSet,'steps',_view.panel)
      .setProperty("Text",()=>textStr)
      .setProperty("X",()=>textX)
      .setProperty("Y",()=>textY)
      .setProperty("Font",font);

    _model.setView(_view);
    _model.reset();
  }

  _createView();
  return _model;
}

window.onload=function(){
  _simulation("_topFrame","./_ejs_library/",null);
};
</script>
</head>

<body>
  <div id="_topFrame"></div>
</body>
</html>

