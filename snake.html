<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>è´ªåƒè›‡ ğŸ</title>
<style>
body{text-align:center;font-family:Arial}
canvas{border:2px solid #333;background:#fafafa}
button,select{margin:5px;padding:6px 10px;font-size:16px}
</style>
</head>
<body>

<h2>è´ªåƒè›‡</h2>

<div>
  é¢œè‰²ï¼š
  <select id="colorSelect">
    <option value="red">çº¢</option>
    <option value="green" selected>ç»¿</option>
    <option value="black">é»‘</option>
    <option value="blue">è“</option>
    <option value="yellow">é»„</option>
    <option value="rainbow">ğŸŒˆ å½©è™¹</option>
  </select>
</div>

<div>
  èº«ä½“ï¼š
  <select id="shapeSelect">
    <option value="square">æ­£æ–¹å½¢</option>
    <option value="circle">åœ†å½¢</option>
  </select>
</div>

<button onclick="startGame()">å¼€å§‹</button>
<button onclick="pauseGame()">æš‚åœ</button>
<br>

<canvas id="game" width="400" height="400"></canvas>

<script>
const size=20, cols=20, rows=20;
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

let snake, dir, apple, rocks;
let run=false, timer;
let hue=0, speed=150;
let snakeColor="green", rainbow=false, bodyShape="square";
let applesEaten=0;

// åˆå§‹åŒ–
function init(){
  snake=[{x:10,y:10}];
  dir={x:1,y:0};
  rocks=[];
  applesEaten=0;
  speed=150;
  createRocks(); // åˆå§‹éšœç¢ä¿ç•™
  spawnApple();
  draw();
}

// åˆå§‹éšœç¢ï¼ˆä¸å†å¢åŠ ï¼‰
function createRocks(){
  for(let i=0;i<6;i++){
    let x,y;
    do{
      x=rand(1,cols-2);
      y=rand(1,rows-2);
    }while(onSnake(x,y));
    rocks.push({x,y});
  }
}

// å®‰å…¨è‹¹æœ
function spawnApple(){
  let x,y;
  do{
    x=rand(1,cols-2);
    y=rand(1,rows-2);
  }while(onSnake(x,y)||onRock(x,y)||nearObstacles(x,y));
  apple={x,y};
}

function onSnake(x,y){return snake.some(s=>s.x===x&&s.y===y);}
function onRock(x,y){return rocks.some(r=>r.x===x&&r.y===y);}

// ä¸¤æ ¼å†… â‰¤1 éšœç¢ï¼ˆå¢™ç®—ï¼‰
function nearObstacles(x,y){
  let c=0;
  for(let dy=-2;dy<=2;dy++){
    for(let dx=-2;dx<=2;dx++){
      let nx=x+dx, ny=y+dy;
      if(nx<0||ny<0||nx>=cols||ny>=rows) c++;
      else if(onRock(nx,ny)) c++;
      if(c>1) return true;
    }
  }
  return false;
}

// ä¸»å¾ªç¯
function loop(){
  let head={x:snake[0].x+dir.x,y:snake[0].y+dir.y};

  if(
    head.x<0||head.y<0||
    head.x>=cols||head.y>=rows||
    onSnake(head.x,head.y)||
    onRock(head.x,head.y)
  ){
    gameOver();return;
  }

  snake.unshift(head);

  if(head.x===apple.x&&head.y===apple.y){
    applesEaten++;
    spawnApple();

    // â­ åªåŠ é€Ÿåº¦ï¼Œä¸åŠ éšœç¢
    if(applesEaten%3===0){
      speed=Math.max(60,speed-10);
      restartTimer();
    }
  }else{
    snake.pop();
  }

  hue=(hue+6)%360;
  draw();
}

// ç»˜åˆ¶
function draw(){
  ctx.clearRect(0,0,400,400);

  // ğŸ
  ctx.font="18px serif";
  ctx.fillText("ğŸ",apple.x*size+2,apple.y*size+18);

  // ğŸª¨
  ctx.fillStyle="#999";
  rocks.forEach(r=>{
    ctx.fillRect(r.x*size,r.y*size,size,size);
  });

  // ğŸ èº«ä½“
  snake.forEach((s,i)=>{
    if(i===0) return;
    ctx.fillStyle=rainbow
      ? `hsl(${(hue+i*18)%360},100%,50%)`
      : snakeColor;

    if(bodyShape==="circle"){
      ctx.beginPath();
      ctx.arc(s.x*size+size/2,s.y*size+size/2,size/2,0,Math.PI*2);
      ctx.fill();
    }else{
      ctx.fillRect(s.x*size,s.y*size,size,size);
    }
  });

  drawHead();
}

// ğŸ è›‡å¤´
function drawHead(){
  let h=snake[0];
  ctx.fillStyle=rainbow?`hsl(${hue},100%,40%)`:snakeColor;

  if(bodyShape==="circle"){
    ctx.beginPath();
    ctx.arc(h.x*size+size/2,h.y*size+size/2,size/2,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle="#fff";
    let ex=dir.x?dir.x*4:0, ey=dir.y?dir.y*4:0;
    ctx.beginPath();
    ctx.arc(h.x*size+size/2+ex-3,h.y*size+size/2+ey-3,2,0,Math.PI*2);
    ctx.arc(h.x*size+size/2+ex+3,h.y*size+size/2+ey+3,2,0,Math.PI*2);
    ctx.fill();
  }else{
    ctx.beginPath();
    if(dir.x===1){
      ctx.moveTo(h.x*size+size,h.y*size+size/2);
      ctx.lineTo(h.x*size,h.y*size);
      ctx.lineTo(h.x*size,h.y*size+size);
    }else if(dir.x===-1){
      ctx.moveTo(h.x*size,h.y*size+size/2);
      ctx.lineTo(h.x*size+size,h.y*size);
      ctx.lineTo(h.x*size+size,h.y*size+size);
    }else if(dir.y===-1){
      ctx.moveTo(h.x*size+size/2,h.y*size);
      ctx.lineTo(h.x*size,h.y*size+size);
      ctx.lineTo(h.x*size+size,h.y*size+size);
    }else{
      ctx.moveTo(h.x*size+size/2,h.y*size+size);
      ctx.lineTo(h.x*size,h.y*size);
      ctx.lineTo(h.x*size+size,h.y*size);
    }
    ctx.fill();
  }
}

// æ§åˆ¶
document.addEventListener("keydown",e=>{
  if((e.key==="ArrowUp"||e.key==="w")&&dir.y!==1) dir={x:0,y:-1};
  if((e.key==="ArrowDown"||e.key==="s")&&dir.y!==-1) dir={x:0,y:1};
  if((e.key==="ArrowLeft"||e.key==="a")&&dir.x!==1) dir={x:-1,y:0};
  if((e.key==="ArrowRight"||e.key==="d")&&dir.x!==-1) dir={x:1,y:0};
});

function startGame(){
  if(run) return;
  snakeColor=document.getElementById("colorSelect").value;
  bodyShape=document.getElementById("shapeSelect").value;
  rainbow=(snakeColor==="rainbow");
  run=true;
  restartTimer();
}

function restartTimer(){
  clearInterval(timer);
  timer=setInterval(loop,speed);
}

function pauseGame(){
  run=false;
  clearInterval(timer);
}

function gameOver(){
  pauseGame();
  alert("æ¸¸æˆç»“æŸ");
  init();
}

function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a;}

init();
</script>
</body>
</html>
